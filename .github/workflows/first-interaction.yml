name: First Contribution Welcome

on:
  issues:
    types: [opened]

  pull_request_target:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Welcome first-time contributor
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isPR = Boolean(context.payload.pull_request);

            const author = isPR
              ? context.payload.pull_request.user.login
              : context.payload.issue.user.login;

            const repo = `${context.repo.owner}/${context.repo.repo}`;
            const currentNumber = context.issue.number;

            // Build correct query
            const query = isPR
              ? `repo:${repo} is:pr author:${author}`
              : `repo:${repo} is:issue author:${author}`;

            const { data } = await github.rest.search.issuesAndPullRequests({ q: query });

            // Exclude the current PR / Issue
            const previousItems = data.items.filter(
              item => item.number !== currentNumber
            );

            // If nothing existed before, this is the first one
            if (previousItems.length === 0) {
              const message = isPR
                ? `ðŸŽ‰ **Welcome @${author}!**\n\nThank you for submitting your **first Pull Request** to this repository ðŸš€\n\nWe really appreciate you taking the time to contribute. A maintainer will review your changes soon â€” feel free to respond to any feedback or questions.\n\n![Thank you](https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWZsZ3ZlNHZyY2FjZ3YxN2I4MWZ3Y2NwNnNhd2VhY2k3d2k4eG9yZSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/3o6Zt481isNVuQI1l6/giphy.gif)`
                : `ðŸ‘‹ **Hi @${author}, welcome!**\n\nThanks for opening your **first issue** ðŸŽ‰\n\nWe appreciate you helping improve this project by reporting problems or suggesting enhancements. A maintainer will take a look shortly.\n\n![Welcome](https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbGx0bWw2M3p6bXQ5cWl2a2V1aXBzN3l6eHJzMWR5b3RzZzN1aWk5diZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ASd0Ukj0y3qMM/giphy.gif)`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentNumber,
                body: message
              });
            }
